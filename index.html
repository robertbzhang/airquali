<!doctype html>
<html lang="en">

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-178387663-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-178387663-1');
  </script>
  <title>Airquali - AQI Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
    content="Look up the air quality near your without a single click. All data is from AirNow, the most accurate AQI provider in the U.S.">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400">
  <link rel="stylesheet" href="index.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>
  <div id="loading-text">Looking up your air quality...</div>
  <div id="aqi-header"></div>
  <div id="aqi"></div>
  <div id="loader" class="hidden"></div>
  <span>
    <input type="checkbox" class="hidden" id="myCheck" onclick="showPurple()">
    <label for="myCheck" class="hidden" id="myCheckLabel">Show PurpleAir data</label>
  </span>
  <div id="map"></div>
  <div id="footer">All data is the latest from AirNow.gov. Data is only available in North America.</div>
  <script type="text/javascript">
    const concentrationBreakpoints = [0, 12.1, 35.5, 55.5, 150.5, 250.5, 500.5, 9999];
    const aqiBreakpoints = [0, 51, 101, 151, 201, 301, 501, 501];

    let latitude, longitude, mapzoom = 9, purpleJson, map, totalPurple, purple;
    const fetchData = async () => {

      const [response, siteData] = await Promise.all([
        fetch('https://serene-sands-18677.herokuapp.com/www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=' + latitude + '&longitude=' + longitude + '&distance=25&API_KEY=AC6C5856-E038-4EE7-A106-5FA8E40F6F5A'),
        fetch('https://serene-sands-18677.herokuapp.com/www.airnowapi.org/aq/data/?parameters=PM25&BBOX=' + (longitude - 20) + ',' + (latitude - 20) + ',' + (longitude + 20) + ',' + (latitude + 20) + '&dataType=A&format=application/json&verbose=0&nowcastonly=0&includerawconcentrations=0&API_KEY=AC6C5856-E038-4EE7-A106-5FA8E40F6F5A'),
      ]);
      const myJson = await response.json();
      const siteDataJson = await siteData.json();
      const result = myJson.find(json => json.ParameterName === "PM2.5");
      document.getElementById("loading-text").remove();
      document.getElementById("aqi-header").innerHTML = "PM2.5 in " + result.ReportingArea + ":";
      document.getElementById("aqi").innerHTML = result.AQI;
      if (result.AQI < 50) document.getElementById("aqi").classList.add("bg-green");
      else if (result.AQI < 100) document.getElementById("aqi").classList.add("bg-yellow");
      else if (result.AQI < 150) document.getElementById("aqi").classList.add("bg-orange");
      else if (result.AQI < 200) document.getElementById("aqi").classList.add("bg-red");
      else if (result.AQI < 250) document.getElementById("aqi").classList.add("bg-purple");
      else document.getElementById("aqi").classList.add("bg-maroon");
      document.getElementById("loader").remove();
      document.getElementById("myCheck").classList.remove("hidden");
      document.getElementById("myCheckLabel").classList.remove("hidden");
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 9,
        center: { lat: latitude, lng: longitude },
        disableDefaultUI: true,
        zoomControl: true,
        fullscreenControl: true,
        clickableIcons: false,
      });
      google.maps.event.addListener(map, 'zoom_changed', function () {
        zoomLevel = map.getZoom();
        if (zoomLevel < mapzoom && zoomLevel < 7) {
          siteDataJson.forEach((site, i) => {
            document.getElementById(i).innerHTML = '';
          });
        }
        if (zoomLevel > mapzoom && zoomLevel >= 7) {
          siteDataJson.forEach((site, i) => {
            document.getElementById(i).innerHTML = site.AQI;
          });
        }
        mapzoom = zoomLevel;
      });

      siteDataJson.forEach((site, i) => {
        const popup = document.createElement('div');
        popup.id = i;
        popup.innerHTML = site.AQI;
        let popupClass;
        if (site.AQI < 50) popupClass = "bg-green";
        else if (site.AQI < 100) popupClass = "bg-yellow";
        else if (site.AQI < 150) popupClass = "bg-orange";
        else if (site.AQI < 200) popupClass = "bg-red";
        else if (site.AQI < 250) popupClass = "bg-purple";
        else popupClass = "bg-maroon";
        popup.classList.add(popupClass);
        var marker = new Popup(new google.maps.LatLng(site.Latitude, site.Longitude), popup);
        marker.setMap(map);
      });
    }

    async function showPurple() {
      console.log("ASDASDASASD")
      console.log(document.getElementById("myCheck"))
      document.getElementById("myCheck").classList.add("hidden");
      // document.getElementById("myCheckLabel").innerHTML = "Show PurpleAir data";
      if (document.getElementById("myCheck").checked) {
        if (!purpleJson) {
          purpleJson = await (await purple).json()
        }
        purpleJson.results.filter(site => site.DEVICE_LOCATIONTYPE === "outside").forEach((site, i) => {
          const popup = document.createElement('div');
          popup.classList.add("purple-popup");
          if (site.Label.includes("Pine Lake")) console.log(site);
          const concentration = parseFloat(site.PM2_5Value);
          let low = 0, high = 1;
          for (let i = 0; i < concentrationBreakpoints.length; i++) {
            const breakpoint = concentrationBreakpoints[i];
            if (breakpoint < concentration) {
              low = i;
              high = i + 1;
            }
          }
          concentrationBreakpoints.forEach((breakpoint, i) => {
          });
          const aqi = Math.round((aqiBreakpoints[high] - 1 - aqiBreakpoints[low]) / (concentrationBreakpoints[high] - 0.1 - concentrationBreakpoints[low]) * (concentration - concentrationBreakpoints[low]) + aqiBreakpoints[low]);
          popup.innerHTML = aqi;
          if (aqi) {
            let popupClass;
            if (aqi < 50) popupClass = "bg-green";
            else if (aqi < 100) popupClass = "bg-yellow";
            else if (aqi < 150) popupClass = "bg-orange";
            else if (aqi < 200) popupClass = "bg-red";
            else if (aqi < 250) popupClass = "bg-purple";
            else popupClass = "bg-maroon";
            popup.classList.add(popupClass);
            var marker = new Popup(new google.maps.LatLng(site.Lat, site.Lon), popup, "purple" + i);
            marker.setMap(map);
            totalPurple = i;
          }
        });
      } else {
        for (let i = 0; i <= totalPurple; i++) {
          if (document.getElementById("purple" + i)) {
            document.getElementById("purple" + i).remove();
          }
        }
      }
      document.getElementById("myCheckLabel").innerHTML = "Show PurpleAir data";
      document.getElementById("myCheck").classList.remove("hidden");
    }

    async function run() {
      document.getElementById("loader").classList.remove("hidden");

      try {
        purple = fetch('https://serene-sands-18677.herokuapp.com/www.purpleair.com/json');
      } catch (e) {
        console.log("FAILED")
        document.getElementById("myCheck").remove();
        document.getElementById("myCheckLabel").remove();
      }
      const ip = await fetch('https://serene-sands-18677.herokuapp.com/api.ipify.org?format=json');
      const ipAddress = await ip.json()
      const location = await fetch('https://serene-sands-18677.herokuapp.com/www.geoplugin.net/json.gp?ip=' + ipAddress.ip);
      const locationJson = await location.json()

      latitude = parseFloat(locationJson.geoplugin_latitude);
      longitude = parseFloat(locationJson.geoplugin_longitude);
      // portland
      // latitude = 45.5051
      // longitude = -122.6750
      // beijing
      // latitude = 39.9042
      // longitude = 116.4074
      await fetchData();
    }
  </script>
  <script defer src="script.js">
  </script>
</body>

</html>