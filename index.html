<!doctype html>
<html lang="en">

<head>
  <title>AQI Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400">
  <link rel="stylesheet" href="index.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body>
  <div id="title">Air Quality Lookup</div>
  <div id="subtitle"></div>
  <div id="aqi-header"></div>
  <div id="aqi"></div>
  <div id="loader" class="hidden"></div>
  <div id="map"></div>
  <div id="popup0"></div>
  <div id="popup1"></div>
  <div id="popup2"></div>
  <div id="popup3"></div>
  <div id="popup4"></div>
  <div id="popup5"></div>
  <div id="popup6"></div>
  <div id="popup7"></div>
  <div id="popup8"></div>
  <div id="popup9"></div>
  <script type="text/javascript">
    let latitude, longitude;
    const fetchData = async () => {
      class Popup extends google.maps.OverlayView {
        constructor(position, content) {
          super();
          this.position = position;
          content.classList.add("popup-bubble");
          // This zero-height div is positioned at the bottom of the bubble.
          const bubbleAnchor = document.createElement("div");
          bubbleAnchor.classList.add("popup-bubble-anchor");
          bubbleAnchor.appendChild(content);
          // This zero-height div is positioned at the bottom of the tip.
          this.containerDiv = document.createElement("div");
          this.containerDiv.classList.add("popup-container");
          this.containerDiv.appendChild(bubbleAnchor);
          // Optionally stop clicks, etc., from bubbling up to the map.
          Popup.preventMapHitsAndGesturesFrom(this.containerDiv);
        }
        /** Called when the popup is added to the map. */
        onAdd() {
          this.getPanes().floatPane.appendChild(this.containerDiv);
        }
        /** Called when the popup is removed from the map. */
        onRemove() {
          if (this.containerDiv.parentElement) {
            this.containerDiv.parentElement.removeChild(this.containerDiv);
          }
        }
        /** Called each frame when the popup needs to draw itself. */
        draw() {
          const divPosition = this.getProjection().fromLatLngToDivPixel(
            this.position
          );
          // Hide the popup when it is far out of view.
          const display =
            Math.abs(divPosition.x) < 4000 && Math.abs(divPosition.y) < 4000
              ? "block"
              : "none";

          if (display === "block") {
            this.containerDiv.style.left = divPosition.x + "px";
            this.containerDiv.style.top = divPosition.y + "px";
          }

          if (this.containerDiv.style.display !== display) {
            this.containerDiv.style.display = display;
          }
        }
      }

      const [response, siteData] = await Promise.all([
        fetch('https://cors-anywhere.herokuapp.com/www.airnowapi.org/aq/observation/latLong/current/?format=application/json&latitude=' + latitude + '&longitude=' + longitude + '&distance=25&API_KEY=AC6C5856-E038-4EE7-A106-5FA8E40F6F5A'),
        fetch('https://cors-anywhere.herokuapp.com/www.airnowapi.org/aq/data/?parameters=PM25&BBOX=' + (longitude - 0.3) + ',' + (latitude - 0.3) + ',' + (longitude + 0.3) + ',' + (latitude + 0.3) + '&dataType=A&format=application/json&verbose=1&nowcastonly=0&includerawconcentrations=0&API_KEY=AC6C5856-E038-4EE7-A106-5FA8E40F6F5A'),
      ]);
      const myJson = await response.json();
      const siteDataJson = await siteData.json();
      console.log(siteDataJson);
      const result = myJson.find(json => json.ParameterName === "PM2.5");
      console.log(result);
      document.getElementById("title").remove();
      document.getElementById("subtitle").remove();
      document.getElementById("aqi-header").innerHTML = "AQI in " + result.ReportingArea + ":";
      document.getElementById("aqi").innerHTML = result.AQI;
      document.getElementById("loader").remove();
      var map = new google.maps.Map(document.getElementById('map'), { zoom: 9, center: { lat: latitude, lng: longitude }, disableDefaultUI: true });
      siteDataJson.slice(0, 10).forEach((site, i) => {
        const popup = document.getElementById("popup" + i);
        popup.innerHTML = site.AQI;
        var marker = new Popup(new google.maps.LatLng(site.Latitude, site.Longitude), popup);
        marker.setMap(map);
      });
    }

    async function run() {
      document.getElementById("loader").classList.remove("hidden");

      const ip = await fetch('https://cors-anywhere.herokuapp.com/api.ipify.org?format=json');
      const ipAddress = await ip.json()
      const location = await fetch('https://cors-anywhere.herokuapp.com/www.geoplugin.net/json.gp?ip=' + ipAddress.ip);
      const locationJson = await location.json()

      latitude = parseFloat(locationJson.geoplugin_latitude);
      longitude = parseFloat(locationJson.geoplugin_longitude);
      await fetchData();
    }
  </script>
  <script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyApXsQ_QBDjIS0x9pHtouGdyVwodcpEixU&callback=run">
  </script>
</body>

</html>